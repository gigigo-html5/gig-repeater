<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/gig-button/gig-button.html">
<link rel="import" href="../bower_components/gig-html/gig-html.html">
<script src="../bower_components/Sortable/Sortable.js"></script>

<dom-module id="gig-repeater">

    <style>

        * {
            box-sizing: border-box;
            font-family: Roboto, sans-serif;
        }

        ::content .clone-content {
            display: none
        }

        .panel {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0,0,0,.05);
            position: relative;
            cursor: move;
        }

        .panel-title {
            padding: 20px 30px;
            font-size: 18px;
            color: #37474f;
            display: block;
            text-shadow: rgba(0,0,0,.15) 0 0 1px;
        }

        .panel-actions {
            position:absolute;
            top: 50%;
            right: 30px;
            z-index: 1;
            margin: auto;
            transform: translate(0,-50%);
            -webkit-transform: translate(0,-50%);
            -o-transform: translate(0,-50%);
            -ms-transform: translate(0,-50%);
        }

        .panel-body {
            padding: 30px 30px;
            padding-top: 0;
            position:relative;
        }

        .panel-heading {
            position: relative;
        }

        .sortable-ghost {
            display: block;
            background-color: #f3f7f9;
            border: 1px dashed #e4eaec;
            margin-top: 20px;

        }

        .sortable-ghost > * {
            visibility: hidden;
        }

    </style>

    <template id="template">

        <content id="c" select=".clone-content"></content>

        <div class="panel-list" id="list">
            <template is="dom-repeat" items="{{cloneElements}}">
                <div class="panel">
                    <div class="panel-heading">
                        <h3 class="panel-title"></h3>
                        <div class="panel-actions">
                            <gig-button class="btn-default btn-icon btn-pure" icon="fa-plus" on-click="cloneHandler"></gig-button>
                            <gig-button class="btn-default btn-icon btn-pure" icon="fa-chevron-up" on-click="sortUpHandler"></gig-button>
                            <gig-button class="btn-default btn-icon btn-pure" icon="fa-chevron-down" on-click="sortDownHandler"></gig-button>
                            <gig-button class="btn-default btn-icon btn-pure" icon="fa-trash" on-click="deleteHandler"></gig-button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <gig-html html="{{item.innerHTML}}"></gig-html>
                    </div>
                </div>
            </template>
        </div>

    </template>

    <script>
        (function() {

            Array.prototype.move = function (from, to) {
                this.splice(to, 0, this.splice(from, 1)[0]);
            };

            Polymer({
                is: 'gig-repeater',
                ready: function() {
                    var self = this;
                    this.cloneElements = Polymer.dom(this.$.c).getDistributedNodes();

                    this.sortable = new Sortable(this.$.list, {
                        draggable: '.panel',
                        ghostClass: 'sortable-ghost',
                        onEnd: function (e) {
                            self.updateIndex();
                        }
                    })

                },
                generateClone: function(index) {
                    index = index + 1;
                    var html = this.cloneElements[0].cloneNode(true);

                    for (var i = 0; i < html.children.length; i++) {
                        var children = html.children[i];

                        if (children.name) {
                            this.nameRegex = new RegExp(this.nameRegex);
                            children.name = children.name.replace(this.nameRegex,'$1'+index+'$3');
                            children.value = null;
                        }
                    }

                    return html;
                },
                cloneHandler: function() {
                    var index = this.cloneElements.length;
                    this.push('cloneElements', this.generateClone(index));
                    this.updateIndex();
                },
                deleteHandler: function(e) {
                    this.splice('cloneElements', e.model.index, 1);
                    this.updateIndex();
                },
                updateIndex: function() {
                    for (var i = 0; i < this.cloneElements.length; i++) {
                        var html = this.cloneElements[i].cloneNode(true);


                        for (var x = 0; x < html.children.length; x++) {
                            var children = html.children[x];

                            if (children.name) {
                                this.nameRegex = new RegExp(this.nameRegex);
                                children.name = children.name.replace(this.nameRegex,'$1'+i+'$3');
                            }
                        }

                        this.set('cloneElements.'+i, html);
                    }
                },
                sortUpHandler: function(e) {
                    var index = e.model.index - 1;
                    this.cloneElements.move(e.model.index, index);
                    this.set('cloneElements', this.cloneElements);
                },
                sortDownHandler: function(e) {
                    var index = e.model.index + 1;
                    this.cloneElements.move(e.model.index, index);
                    this.notifyPath('cloneElements', this.cloneElements);

                    var array = [];

                    for (var i = 0; i < this.cloneElements.length; i++) {
                        for (var x = 0; x < this.cloneElements[i].children.length; x++) {

                        }

                        array.push(this.cloneElements[i]);
                    }

                    this.set('cloneElements', array);
                },
                properties: {
                    cloneElements: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    nameRegex: {
                        type: String
                    }
                }
            })
        })();
    </script>

</dom-module>
